var __jailed__path__;var __is__node__=typeof process!=="undefined"&&!process.browser&&process.release.name.search(/node|io.js/)!==-1;if(__is__node__){__jailed__path__=__dirname+"/"}else{var scripts=document.getElementsByTagName("script");__jailed__path__=scripts[scripts.length-1].src.split("?")[0].split("/").slice(0,-1).join("/")+"/"}(function(root,factory){if(typeof define==="function"&&define.amd){define(["exports"],factory)}else if(typeof exports!=="undefined"){factory(exports)}else{factory(root.jailed={})}})(this,function(exports){var Whenable=function(){this._emitted=false;this._handlers=[]};Whenable.prototype.emit=function(){if(!this._emitted){this._emitted=true;var handler;while(handler=this._handlers.pop()){setTimeout(handler,0)}}};Whenable.prototype.whenEmitted=function(handler){handler=this._checkHandler(handler);if(this._emitted){setTimeout(handler,0)}else{this._handlers.push(handler)}};Whenable.prototype._checkHandler=function(handler){var type=typeof handler;if(type!="function"){var msg="A function may only be subsribed to the event, "+type+" was provided instead";throw new Error(msg)}return handler};var initNode=function(){require("./_JailedSite.js")};var platformInit;var initWeb=function(){var load=function(path,cb){var script=document.createElement("script");script.src=path;var clear=function(){script.onload=null;script.onerror=null;script.onreadystatechange=null;script.parentNode.removeChild(script)};var success=function(){clear();cb()};script.onerror=clear;script.onload=success;script.onreadystatechange=function(){var state=script.readyState;if(state==="loaded"||state==="complete"){success()}};document.body.appendChild(script)};platformInit=new Whenable;var origOnload=window.onload||function(){};window.onload=function(){origOnload();load(__jailed__path__+"_JailedSite.js",function(){platformInit.emit()})}};var BasicConnection;var basicConnectionNode=function(){var childProcess=require("child_process");BasicConnection=function(){this.dedicatedThread=true;this._disconnected=false;this._messageHandler=function(){};this._disconnectHandler=function(){};this._process=childProcess.fork(__jailed__path__+"_pluginNode.js");var me=this;this._process.on("message",function(m){me._messageHandler(m)});this._process.on("exit",function(m){me._disconnected=true;me._disconnectHandler(m)})};BasicConnection.prototype.whenInit=function(handler){handler()};BasicConnection.prototype.send=function(data){if(!this._disconnected){this._process.send(data)}};BasicConnection.prototype.onMessage=function(handler){this._messageHandler=function(data){try{handler(data)}catch(e){console.error();console.error(e.stack)}}};BasicConnection.prototype.onDisconnect=function(handler){this._disconnectHandler=handler};BasicConnection.prototype.disconnect=function(){this._process.kill("SIGKILL");this._disconnected=true}};var basicConnectionWeb=function(){var perm=["allow-scripts"];if(__jailed__path__.substr(0,7).toLowerCase()=="file://"){perm.push("allow-same-origin")}var sample=document.createElement("iframe");sample.src=__jailed__path__+"_frame.html";sample.sandbox=perm.join(" ");sample.style.display="none";BasicConnection=function(){this._init=new Whenable;this._disconnected=false;var me=this;platformInit.whenEmitted(function(){if(!me._disconnected){me._frame=sample.cloneNode(false);document.body.appendChild(me._frame);window.addEventListener("message",function(e){if(e.source===me._frame.contentWindow){if(e.data.type=="initialized"){me.dedicatedThread=e.data.dedicatedThread;me._init.emit()}else{me._messageHandler(e.data)}}})}})};BasicConnection.prototype.whenInit=function(handler){this._init.whenEmitted(handler)};BasicConnection.prototype.send=function(data){this._frame.contentWindow.postMessage({type:"message",data:data},"*")};BasicConnection.prototype.onMessage=function(handler){this._messageHandler=handler};BasicConnection.prototype.onDisconnect=function(){};BasicConnection.prototype.disconnect=function(){if(!this._disconnected){this._disconnected=true;if(typeof this._frame!="undefined"){this._frame.parentNode.removeChild(this._frame)}}}};if(__is__node__){initNode();basicConnectionNode()}else{initWeb();basicConnectionWeb()}var Connection=function(){this._platformConnection=new BasicConnection;this._importCallbacks={};this._executeSCb=function(){};this._executeFCb=function(){};this._messageHandler=function(){};var me=this;this.whenInit=function(cb){me._platformConnection.whenInit(cb)};this._platformConnection.onMessage(function(m){switch(m.type){case"message":me._messageHandler(m.data);break;case"importSuccess":me._handleImportSuccess(m.url);break;case"importFailure":me._handleImportFailure(m.url);break;case"executeSuccess":me._executeSCb();break;case"executeFailure":me._executeFCb();break}})};Connection.prototype.hasDedicatedThread=function(){return this._platformConnection.dedicatedThread};Connection.prototype.importScript=function(path,sCb,fCb){var f=function(){};this._importCallbacks[path]={sCb:sCb||f,fCb:fCb||f};this._platformConnection.send({type:"import",url:path})};Connection.prototype.importJailedScript=function(path,sCb,fCb){var f=function(){};this._importCallbacks[path]={sCb:sCb||f,fCb:fCb||f};this._platformConnection.send({type:"importJailed",url:path})};Connection.prototype.execute=function(code,sCb,fCb){this._executeSCb=sCb||function(){};this._executeFCb=fCb||function(){};this._platformConnection.send({type:"execute",code:code})};Connection.prototype.onMessage=function(handler){this._messageHandler=handler};Connection.prototype.onDisconnect=function(handler){this._platformConnection.onDisconnect(handler)};Connection.prototype.send=function(data){this._platformConnection.send({type:"message",data:data})};Connection.prototype._handleImportSuccess=function(url){var sCb=this._importCallbacks[url].sCb;this._importCallbacks[url]=null;delete this._importCallbacks[url];sCb()};Connection.prototype._handleImportFailure=function(url){var fCb=this._importCallbacks[url].fCb;this._importCallbacks[url]=null;delete this._importCallbacks[url];fCb()};Connection.prototype.disconnect=function(){this._platformConnection.disconnect()};var Plugin=function(url,_interface){this._path=url;this._initialInterface=_interface||{};this._connect()};var DynamicPlugin=function(code,_interface){this._code=code;this._initialInterface=_interface||{};this._connect()};DynamicPlugin.prototype._connect=Plugin.prototype._connect=function(){this.remote=null;this._connect=new Whenable;this._fail=new Whenable;this._disconnect=new Whenable;var me=this;this._fCb=function(){me._fail.emit();me.disconnect()};this._connection=new Connection;this._connection.whenInit(function(){me._init()})};DynamicPlugin.prototype._init=Plugin.prototype._init=function(){this._site=new JailedSite(this._connection);var me=this;this._site.onDisconnect(function(){me._disconnect.emit()});var sCb=function(){me._loadCore()};this._connection.importScript(__jailed__path__+"_JailedSite.js",sCb,this._fCb)};DynamicPlugin.prototype._loadCore=Plugin.prototype._loadCore=function(){var me=this;var sCb=function(){me._sendInterface()};this._connection.importScript(__jailed__path__+"_pluginCore.js",sCb,this._fCb)};DynamicPlugin.prototype._sendInterface=Plugin.prototype._sendInterface=function(){var me=this;this._site.onInterfaceSetAsRemote(function(){if(!me._connected){me._loadPlugin()}});this._site.setInterface(this._initialInterface)};Plugin.prototype._loadPlugin=function(){var me=this;var sCb=function(){me._requestRemote()};this._connection.importJailedScript(this._path,sCb,this._fCb)};DynamicPlugin.prototype._loadPlugin=function(){var me=this;var sCb=function(){me._requestRemote()};this._connection.execute(this._code,sCb,this._fCb)};DynamicPlugin.prototype._requestRemote=Plugin.prototype._requestRemote=function(){var me=this;this._site.onRemoteUpdate(function(){me.remote=me._site.getRemote();me._connect.emit()});this._site.requestRemote()};DynamicPlugin.prototype.hasDedicatedThread=Plugin.prototype.hasDedicatedThread=function(){return this._connection.hasDedicatedThread()};DynamicPlugin.prototype.disconnect=Plugin.prototype.disconnect=function(){this._connection.disconnect();this._disconnect.emit()};DynamicPlugin.prototype.whenFailed=Plugin.prototype.whenFailed=function(handler){this._fail.whenEmitted(handler)};DynamicPlugin.prototype.whenConnected=Plugin.prototype.whenConnected=function(handler){this._connect.whenEmitted(handler)};DynamicPlugin.prototype.whenDisconnected=Plugin.prototype.whenDisconnected=function(handler){this._disconnect.whenEmitted(handler)};exports.Plugin=Plugin;exports.DynamicPlugin=DynamicPlugin});